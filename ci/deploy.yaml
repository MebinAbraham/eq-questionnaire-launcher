platform: linux
image_resource:
  type: docker-image
  source:
    repository: theorf/google-cloud-sdk-helm
params:
  GOOGLE_APPLICATION_CREDENTIALS: /root/gcloud-service-key.json
  SERVICE_ACCOUNT_JSON: ((gcp.service_account_json))
  DOCKER_REGISTRY: eu.gcr.io/census-eq-ci
  IMAGE_TAG: latest
  RUNNER_URL:
  REGION:
  PROJECT_ID:
inputs:
  - name: eq-questionnaire-launcher-repo
run:
  path: bash
  args:
    - -exc
    - |
      apt-get install -y procps

      cat >$GOOGLE_APPLICATION_CREDENTIALS <<EOL
      $SERVICE_ACCOUNT_JSON
      EOL

      gcloud auth activate-service-account --key-file $GOOGLE_APPLICATION_CREDENTIALS
      gcloud container clusters get-credentials survey-runner --region ${REGION} --project ${PROJECT_ID}

      helm init --client-only
      helm plugin install https://github.com/rimusz/helm-tiller || :

      cd eq-questionnaire-launcher-repo
      ./k8s/deploy_app.sh
